# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define executors for reuse across jobs
# See: https://circleci.com/docs/reference/configuration-reference/#executors
executors:
  node-executor:
    docker:
      - image: cimg/node:20.10

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build-and-test:
    # Use Docker executor with Docker-in-Docker support
    docker:
      - image: cimg/base:stable

    # Add steps to the job
    # See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#steps-overview & https://circleci.com/docs/reference/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      
      # Setup Docker-in-Docker to enable Docker builds
      - setup_remote_docker
      
      # Build the Docker image (equivalent to before_install in Travis)
      - run:
          name: Build Docker image
          command: docker build -t denzik10/docker-react -f Dockerfile.dev .
      
      # Run tests (equivalent to script in Travis)
      - run:
          name: Run tests
          command: docker run -e CI=true denzik10/docker-react npm run test -- --coverage

  build-and-deploy:
    # Use the node executor defined above (matches article pattern)
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install --include=dev
      - run:
          name: Build the project
          command: npm run build
      - run:
          name: Install Python and pip
          command: |
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip
      - run:
          name: Install AWS EB CLI
          command: |
            pip3 install --upgrade pip
            pip3 install awsebcli --upgrade --user
            export PATH=$HOME/.local/bin:$PATH
      - run:
          name: Configure AWS credentials
          command: |
            # Configure AWS credentials for EB CLI
            # EB CLI uses the profile specified in .elasticbeanstalk/config.yml (eb-cli)
            mkdir -p ~/.aws
            cat > ~/.aws/credentials << EOF
            [default]
            aws_access_key_id = ${AWS_ACCESS_KEY_ID}
            aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
            [eb-cli]
            aws_access_key_id = ${AWS_ACCESS_KEY_ID}
            aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
            EOF
            cat > ~/.aws/config << EOF
            [default]
            region = ${AWS_DEFAULT_REGION}
            [profile eb-cli]
            region = ${AWS_DEFAULT_REGION}
            EOF
      - run:
          name: Initialize EB CLI (if needed)
          command: |
            export PATH=$HOME/.local/bin:$PATH
            # Check if .elasticbeanstalk/config.yml exists, if not initialize
            if [ ! -f .elasticbeanstalk/config.yml ]; then
              echo "EB not initialized. Initializing now..."
              # Initialize EB non-interactively with Node.js platform
              # Uses environment variables: AWS_DEFAULT_REGION and EB_APPLICATION_NAME (optional)
              eb init \
                --platform "Node.js 18 running on 64bit Amazon Linux 2" \
                --region "${AWS_DEFAULT_REGION:-us-east-1}" \
                ${EB_APPLICATION_NAME:+--application-name "$EB_APPLICATION_NAME"} \
                --no-verify-ssl \
                --no-interactive || echo "Warning: EB init failed. Make sure to run 'eb init' locally and commit .elasticbeanstalk directory."
            else
              echo "EB already initialized."
            fi
      - run:
          name: Deploy to AWS Elastic Beanstalk
          command: |
            export PATH=$HOME/.local/bin:$PATH
            # EB CLI will use the eb-cli profile configured above
            eb deploy Frontend-env

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  build_and_deploy:
    jobs:
      # Run build and test on all branches
      - build-and-test
      # Deploy to Elastic Beanstalk only on main branch, after tests pass
      - build-and-deploy:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - main